trigger:
  - main
  - develop

pr:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  buildPlatform: 'x64'
  nodeVersion: '18.x'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        steps:
          - checkout: self
            fetchDepth: 0
          
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
              checkLatest: true
            displayName: 'Set up Node.js'
          
          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: npm | "$(Agent.OS)"
              path: $(npm_config_cache)
            displayName: 'Cache npm packages'
          
          - script: npm ci --prefer-offline
            displayName: 'Install dependencies'
          
          - script: npm run build
            displayName: 'Build application'
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: UnitTest
        displayName: 'Unit Tests'
        steps:
          - checkout: self
          
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
          
          - script: npm ci
          
          - script: npm run test:unit -- --coverage
            displayName: 'Run unit tests'
          
          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: Cobertura
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'

      - job: IntegrationTest
        displayName: 'Integration Tests'
        steps:
          - checkout: self
          
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
          
          - script: npm ci
          
          - script: npm run test:integration
            displayName: 'Run integration tests'

  - stage: Quality
    displayName: 'Code Quality'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: CodeQuality
        displayName: 'Code Quality Checks'
        steps:
          - checkout: self
            fetchDepth: 0
          
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
          
          - script: npm ci
          
          - script: npm run lint
            displayName: 'Run linter'
          
          - script: npm run format:check
            displayName: 'Check code formatting'

  - stage: Security
    displayName: 'Security'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: SecurityScan
        displayName: 'Security Analysis'
        steps:
          - checkout: self
          
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
          
          - script: npm audit --audit-level=moderate
            displayName: 'Audit dependencies'
            continueOnError: true

  - stage: DeployStaging
    displayName: 'Deploy Staging'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployToStaging
        displayName: 'Deploy to Staging'
        environment: 'Staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: 'drop'
                
                - script: echo "Deploying to staging..."

  - stage: DeployProduction
    displayName: 'Deploy Production'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Production'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: 'drop'
                
                - script: echo "Deploying to production..."
